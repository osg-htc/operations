
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="canonical" href="https://osg-htc.org/operations/services/topology/">
      
      <link rel="icon" href="../../img/favicon.ico">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.1.0">
    
    
      
        <title>Topology Service - OSG Operations</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.33e2939f.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ef6f36e2.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="../../css/extra.css">
    
    
      
        
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-69012-29","opensciencegrid.github.io"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){var e;this.value&&(e=document.location.pathname,ga("send","pageview",e+"?q="+this.value))}),"undefined"!=typeof location$&&location$.subscribe(function(e){ga("send","pageview",e.pathname)})})</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#topology-service" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="OSG Operations" class="md-header__button md-logo" aria-label="OSG Operations" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            OSG Operations
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Topology Service
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/osg-htc/operations/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="OSG Operations" class="md-nav__button md-logo" aria-label="OSG Operations" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    OSG Operations
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/osg-htc/operations/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      <label class="md-nav__link" for="__nav_2">
        Services
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Services" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Services
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../install-gwms-factory/" class="md-nav__link">
        Installing GlideinWMS Factory
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Topology Service
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Topology Service
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#deployment" class="md-nav__link">
    Deployment
  </a>
  
    <nav class="md-nav" aria-label="Deployment">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#installation" class="md-nav__link">
    Installation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#file-system-locations" class="md-nav__link">
    File system locations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#software-configuration" class="md-nav__link">
    Software configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-configuration" class="md-nav__link">
    Data configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#github-configuration-for-webhook-app" class="md-nav__link">
    GitHub Configuration for Webhook App
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#required-system-packages" class="md-nav__link">
    Required System Packages
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-changes-on-the-itb-instance" class="md-nav__link">
    Testing changes on the ITB instance
  </a>
  
    <nav class="md-nav" aria-label="Testing changes on the ITB instance">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reverting-changes" class="md-nav__link">
    Reverting changes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#updating-the-production-instance" class="md-nav__link">
    Updating the production instance
  </a>
  
    <nav class="md-nav" aria-label="Updating the production instance">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reverting-changes_1" class="md-nav__link">
    Reverting changes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../topology-contacts-data/" class="md-nav__link">
        Topology and Contacts Data
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../finalize-cache-registration/" class="md-nav__link">
        Finalize Cache Registration
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../sending-announcements/" class="md-nav__link">
        Sending Announcements
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../gracc-corrections/" class="md-nav__link">
        GRACC Corrections
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../hosted-ce-definitions/" class="md-nav__link">
        Hosted CE Definitions
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../ce-monitoring-dashboards/" class="md-nav__link">
        CE Monitoring Dashboards
      </a>
    </li>
  

          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_9" type="checkbox" id="__nav_2_9" >
      
      <label class="md-nav__link" for="__nav_2_9">
        Yum Repository
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Yum Repository" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_9">
          <span class="md-nav__icon md-icon"></span>
          Yum Repository
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../troubleshooting/repository-scripts/" class="md-nav__link">
        Troubleshooting Guide for Yum Repository Scripts
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      <label class="md-nav__link" for="__nav_3">
        Service Level Agreements
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Service Level Agreements" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Service Level Agreements
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../SLA/general/" class="md-nav__link">
        General
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../SLA/access-point/" class="md-nav__link">
        Access Point
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../SLA/collector/" class="md-nav__link">
        CE Collector
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../SLA/gracc/" class="md-nav__link">
        GRACC
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../SLA/gwms-factory/" class="md-nav__link">
        GWMS Factory
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../SLA/gwms-frontend/" class="md-nav__link">
        GWMS Frontend
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../SLA/htcss-central-manager/" class="md-nav__link">
        HTCSS Central Manager
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../SLA/hosted-ce/" class="md-nav__link">
        Hosted CE
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../SLA/message-broker/" class="md-nav__link">
        Message Broker
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../SLA/oasis/" class="md-nav__link">
        OASIS
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../SLA/osdf-core/" class="md-nav__link">
        OSDF Core
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../SLA/osdf-cache/" class="md-nav__link">
        OSDF Cache
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../SLA/osdf-origin/" class="md-nav__link">
        OSDF Origin
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../SLA/perfsonar/" class="md-nav__link">
        PerfSonar
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../SLA/software-repo/" class="md-nav__link">
        Software Repository
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../SLA/topology/" class="md-nav__link">
        Topology
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../SLA/web-pages/" class="md-nav__link">
        Web Pages
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../SLA/xdlogin/" class="md-nav__link">
        XDLogin
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../external-oasis-repos/" class="md-nav__link">
        External OASIS repositories
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#deployment" class="md-nav__link">
    Deployment
  </a>
  
    <nav class="md-nav" aria-label="Deployment">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#installation" class="md-nav__link">
    Installation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#file-system-locations" class="md-nav__link">
    File system locations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#software-configuration" class="md-nav__link">
    Software configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-configuration" class="md-nav__link">
    Data configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#github-configuration-for-webhook-app" class="md-nav__link">
    GitHub Configuration for Webhook App
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#required-system-packages" class="md-nav__link">
    Required System Packages
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-changes-on-the-itb-instance" class="md-nav__link">
    Testing changes on the ITB instance
  </a>
  
    <nav class="md-nav" aria-label="Testing changes on the ITB instance">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reverting-changes" class="md-nav__link">
    Reverting changes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#updating-the-production-instance" class="md-nav__link">
    Updating the production instance
  </a>
  
    <nav class="md-nav" aria-label="Updating the production instance">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reverting-changes_1" class="md-nav__link">
    Reverting changes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/osg-htc/operations/edit/master/docs/services/topology.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="topology-service">Topology Service</h1>
<p>This document contains information about the service that runs:</p>
<ul>
<li><a href="https://topology.opensciencegrid.org">https://topology.opensciencegrid.org</a></li>
<li><a href="https://topology-itb.opensciencegrid.org">https://topology-itb.opensciencegrid.org</a></li>
<li><a href="https://map.opensciencegrid.org">https://map.opensciencegrid.org</a>: Generates the topology map used on <a href="https://display.opensciencegrid.org">OSG Display</a></li>
</ul>
<p>The source code for the service is in <a href="https://github.com/opensciencegrid/topology">https://github.com/opensciencegrid/topology</a>, in the <code>src/</code> subdirectory.
This repository also contains the public part of the data that gets served.</p>
<h2 id="deployment">Deployment</h2>
<p>Topology is a webapp run with Apache on the host <code>topology.opensciencegrid.org</code>.
The ITB instance runs on the host <code>topology-itb.opensciencegrid.org</code>.
The hosts are VMs at Nebraska;
for SSH access, contact Derek Weitzel or Brian Bockelman.</p>
<h3 id="installation">Installation</h3>
<p>These instructions assume an EL 7 host with the EPEL repositories available.
The software will be installed into <code>/opt/topology</code>.
A second instance for the webhook app will be installed into <code>/opt/topology-webhook</code>.
(The ITB instance should be installed into <code>/opt/topology-itb</code> and <code>/opt/topology-itb-webhook</code> instead.)
The following steps should be done as root.</p>
<ol>
<li>
<p>Install prerequisites:</p>
<div class="codehilite"><pre><span></span><code><span class="gp"># </span>yum install python36 gridsite httpd mod_ssl
</code></pre></div>

</li>
<li>
<p>Clone the repository:</p>
<p>For the production topology host:</p>
<div class="codehilite"><pre><span></span><code><span class="gp"># </span>git clone https://github.com/opensciencegrid/topology /opt/topology
<span class="gp"># </span>git clone https://github.com/opensciencegrid/topology /opt/topology-webhook
</code></pre></div>

<p>For the topology-itb host:</p>
<div class="codehilite"><pre><span></span><code><span class="gp"># </span>git clone https://github.com/opensciencegrid/topology /opt/topology-itb
<span class="gp"># </span>git clone https://github.com/opensciencegrid/topology /opt/topology-itb-webhook
</code></pre></div>

</li>
<li>
<p>Set up the virtualenv in the clone -- from <code>/opt/topology</code> or <code>/opt/topology-itb</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="gp"># </span>python36 -m venv venv
<span class="gp"># </span>. ./venv/bin/activate
<span class="gp"># </span>pip install -r requirements-apache.txt
</code></pre></div>

</li>
<li>
<p>Repeat for the webhook instance -- from <code>/opt/topology-webhook</code> or <code>/opt/topology-itb-webhook</code>.</p>
</li>
</ol>
<h3 id="file-system-locations">File system locations</h3>
<p>The following files/directories must exist and have the proper permissions:</p>
<table>
<thead>
<tr>
<th>Location</th>
<th>Purpose</th>
<th>Ownership</th>
<th>Mode</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/opt/topology</code></td>
<td>Production software install</td>
<td>root:root</td>
<td>0755</td>
</tr>
<tr>
<td><code>/opt/topology-itb</code></td>
<td>ITB software install</td>
<td>root:root</td>
<td>0755</td>
</tr>
<tr>
<td><code>/opt/topology-webhook</code></td>
<td>Production webhook software install</td>
<td>root:root</td>
<td>0755</td>
</tr>
<tr>
<td><code>/opt/topology-itb-webhook</code></td>
<td>ITB webhook software install</td>
<td>root:root</td>
<td>0755</td>
</tr>
<tr>
<td><code>/etc/opt/topology/config-production.py</code></td>
<td>Production config</td>
<td>root:root</td>
<td>0644</td>
</tr>
<tr>
<td><code>/etc/opt/topology/config-itb.py</code></td>
<td>ITB config</td>
<td>root:root</td>
<td>0644</td>
</tr>
<tr>
<td><code>/etc/opt/topology/bitbucket</code></td>
<td>Private key for contact info repo</td>
<td>apache:root</td>
<td>0600</td>
</tr>
<tr>
<td><code>/etc/opt/topology/bitbucket.pub</code></td>
<td>Public key for contact info repo</td>
<td>apache:root</td>
<td>0644</td>
</tr>
<tr>
<td><code>/etc/opt/topology/github</code></td>
<td>Private key for pushing automerge commits</td>
<td>topomerge:root</td>
<td>0600</td>
</tr>
<tr>
<td><code>/etc/opt/topology/github.pub</code></td>
<td>Public key for pushing automerge commits</td>
<td>topomerge:root</td>
<td>0644</td>
</tr>
<tr>
<td><code>/etc/opt/topology/github_webhook_secret</code></td>
<td>GitHub webhook secret for validating webhooks</td>
<td>topomerge:root</td>
<td>0600</td>
</tr>
<tr>
<td><code>~apache/.ssh</code></td>
<td>SSH dir for Apache</td>
<td>apache:root</td>
<td>0700</td>
</tr>
<tr>
<td><code>~apache/.ssh/known_hosts</code></td>
<td>Known hosts file for Apache</td>
<td>apache:root</td>
<td>0644</td>
</tr>
<tr>
<td><code>~topomerge</code></td>
<td>Home dir for <code>topomerge</code> Apache user</td>
<td>topomerge:root</td>
<td>0755</td>
</tr>
<tr>
<td><code>~topomerge/.ssh</code></td>
<td>SSH dir for <code>topomerge</code> Apache user</td>
<td>topomerge:root</td>
<td>0700</td>
</tr>
<tr>
<td><code>~topomerge/.ssh/known_hosts</code></td>
<td>Known hosts file for <code>topomerge</code> Apache user</td>
<td>topomerge:root</td>
<td>0644</td>
</tr>
<tr>
<td><code>/var/cache/topology</code></td>
<td>Checkouts of topology and contacts data for production instance</td>
<td>apache:apache</td>
<td>0755</td>
</tr>
<tr>
<td><code>/var/cache/topology-itb</code></td>
<td>Checkouts of topology and contacts data for ITB instance</td>
<td>apache:apache</td>
<td>0755</td>
</tr>
<tr>
<td><code>/var/cache/topology-webhook</code></td>
<td>Topology repo and state info for production webhook instance</td>
<td>topomerge:topomerge</td>
<td>0755</td>
</tr>
<tr>
<td><code>/var/cache/topology-itb-webhook</code></td>
<td>Topology repo and state info for ITB webhook instance</td>
<td>topomerge:topomerge</td>
<td>0755</td>
</tr>
</tbody>
</table>
<p><code>~apache/.ssh/known_hosts</code> must contain an entry for <code>bitbucket.org</code>;
use <code>ssh-keyscan bitbucket.org</code> to get the appropriate entry.</p>
<p><code>~topomerge/.ssh/known_hosts</code> must contain an entry for <code>github.com</code>;
use <code>ssh-keyscan github.com</code> to get the appropriate entry.</p>
<h3 id="software-configuration">Software configuration</h3>
<p>Configuration for the main app is under <code>/etc/opt/topology/</code>, in <code>config-production.py</code> and <code>config-itb.py</code>.
The webhook app configuration is in <code>config-production-webhook.py</code> and <code>config-itb-webhook.py</code>.
The files are in Python format and override default settings in <code>src/webapp/default_config.py</code> in the topology repo.</p>
<p>HTTPD configuration is in <code>/etc/httpd</code>; we use the modules <code>mod_ssl</code>, <code>mod_gridsite</code>, and <code>mod_wsgi</code>.
The first two are installed via yum;
the .so file for mod_wsgi is located in <code>/opt/topology/venv/lib/python3.6/site-packages/mod_wsgi/server/</code>
or <code>/opt/topology-itb/venv/lib/python3.6/site-packages/mod_wsgi/server/</code> for the ITB instance.</p>
<p>Each of the hostnames are VHosts in the apache configuration.  Some special notes:</p>
<ul>
<li><a href="https://map.opensciencegrid.org">https://map.opensciencegrid.org</a> runs in the same wsgi process as the production topology, but the URL is limited to only the map code.  Further, it does not use mod_gridsite so that users are not asked to present a client certificate.</li>
<li>VHosts are configured:<div class="codehilite"><pre><span></span><code><span class="go">ServerName topology.opensciencegrid.org</span>
<span class="go">ServerAlias my.opensciencegrid.org myosg.opensciencegrid.org</span>
</code></pre></div>

</li>
</ul>
<h3 id="data-configuration">Data configuration</h3>
<p>Configuration is in <code>/etc/opt/topology/config-production.py</code> and <code>config-itb.py</code>;
and <code>config-production-webhook.py</code> and <code>config-itb-webhook.py</code>.</p>
<table>
<thead>
<tr>
<th>Variable</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>TOPOLOGY_DATA_DIR</code></td>
<td>The directory containing a clone of the <code>topology</code> repository for data use</td>
</tr>
<tr>
<td><code>TOPOLOGY_DATA_REPO</code></td>
<td>The remote tracking repository of <code>TOPOLOGY_DATA_DIR</code></td>
</tr>
<tr>
<td><code>TOPOLOGY_DATA_BRANCH</code></td>
<td>The remote tracking branch of <code>TOPOLOGY_DATA_DIR</code></td>
</tr>
<tr>
<td><code>WEBHOOK_DATA_DIR</code></td>
<td>The directory containing a mirror-clone of the <code>topology</code> repository for webhook use</td>
</tr>
<tr>
<td><code>WEBHOOK_DATA_REPO</code></td>
<td>The remote tracking repository of <code>WEBHOOK_DATA_DIR</code></td>
</tr>
<tr>
<td><code>WEBHOOK_DATA_BRANCH</code></td>
<td>The remote tracking branch of <code>WEBHOOK_DATA_DIR</code></td>
</tr>
<tr>
<td><code>WEBHOOK_STATE_DIR</code></td>
<td>Directory containing webhook state information between pull request and status hooks</td>
</tr>
<tr>
<td><code>WEBHOOK_SECRET_KEY</code></td>
<td>Secret key configured on GitHub for webhook delivery</td>
</tr>
<tr>
<td><code>CONTACT_DATA_DIR</code></td>
<td>The directory containing a clone of the <code>contact</code> repository for data use</td>
</tr>
<tr>
<td><code>CONTACT_DATA_REPO</code></td>
<td>The remote tracking repository of <code>CONTACT_DATA_DIR</code></br>(default: <code>"git@bitbucket.org:opensciencegrid/contact.git"</code>)</td>
</tr>
<tr>
<td><code>CONTACT_DATA_BRANCH</code></td>
<td>The remote tracking branch of <code>CONTACT_DATA_BRANCH</code></br>(default: <code>"master"</code>)</td>
</tr>
<tr>
<td><code>CACHE_LIFETIME</code></td>
<td>Frequency of automatic data updates in seconds</br>(default: <code>900</code>)</td>
</tr>
<tr>
<td><code>GIT_SSH_KEY</code></td>
<td>Location of ssh public key file for git access.<br/></td>
</tr>
<tr>
<td><code>/etc/opt/topology/bitbucket.pub</code> for the main app, and <code>/etc/opt/topology/github.pub</code> for the webhook app</td>
<td></td>
</tr>
</tbody>
</table>
<p>Puppet ensures that the production <code>contact</code> and <code>topology</code> clones are up to date with their configured remote tracking
repo and branch.
Puppet does not manage the ITB data directories so they need to be updated by hand during testing.</p>
<h3 id="github-configuration-for-webhook-app">GitHub Configuration for Webhook App</h3>
<ol>
<li>
<p>Go to the <code>https://github.com/opensciencegrid/topology/settings/hooks</code> page on GitHub.
     There are four webhooks to set up; <code>pull_request</code> and <code>status</code> for both the topology and topology-itb hosts.</p>
<table>
<thead>
<tr>
<th>Payload URL</th>
<th>Content type</th>
<th>Events to trigger webhook</th>
</tr>
</thead>
<tbody>
<tr>
<td>https://topology.opensciencegrid.org/webhook/status</td>
<td>application/json</td>
<td>Statuses</td>
</tr>
<tr>
<td>https://topology.opensciencegrid.org/webhook/pull_request</td>
<td>application/json</td>
<td>Pull requests</td>
</tr>
<tr>
<td>https://topology-itb.opensciencegrid.org/webhook/status</td>
<td>application/json</td>
<td>Statuses</td>
</tr>
<tr>
<td>https://topology-itb.opensciencegrid.org/webhook/pull_request</td>
<td>application/json</td>
<td>Pull requests</td>
</tr>
</tbody>
</table>
<p>For each webhook, "Secret" should be a random 40 digit hex string, which should match the contents of the file
 <code>/etc/opt/topology/github_webhook_secret</code> (the path configured in <code>WEBHOOK_SECRET_KEY</code>).</p>
</li>
<li>
<p>The OSG's dedicated GitHub user for automating pushes is currently <a href="https://github.com/osg-bot">osg-bot</a>.</p>
<ol>
<li>
<p>This user needs to have write access to the <a href="https://github.com/opensciencegrid/topology">topology</a> repo on GitHub.</p>
</li>
<li>
<p>The ssh public key in <code>/etc/opt/topology/github.pub</code> should be registered with the <code>osg-bot</code> GitHub user.</p>
<p>This can be done by logging into GitHub as <code>osg-bot</code>, and adding the new ssh key under the
 <a href="https://github.com/settings/keys">settings</a> page.</p>
</li>
</ol>
</li>
</ol>
<h3 id="required-system-packages">Required System Packages</h3>
<p>Currently the webhook app uses the <code>mailx</code> command to send email.
If not already installed, install it with:</p>
<div class="codehilite"><pre><span></span><code>    :::console
    # yum install mailx
</code></pre></div>

<h2 id="testing-changes-on-the-itb-instance">Testing changes on the ITB instance</h2>
<p>All changes should be tested on the ITB instance before deploying to production.
If you can, test them on your local machine first.
These instructions assume that the code has not been merged to master.</p>
<ol>
<li>
<p>Update the ITB software installation at <code>/opt/topology-itb</code> and note the current branch:</p>
<div class="codehilite"><pre><span></span><code><span class="gp"># </span><span class="nb">cd</span> /opt/topology-itb
<span class="gp"># </span>git fetch --all
<span class="gp"># </span>git status
</code></pre></div>

</li>
<li>
<p>Check out the branch you are testing.
    If the target remote is not configured, <a href="https://help.github.com/articles/adding-a-remote/">add it</a>:</p>
<div class="codehilite"><pre><span></span><code><span class="gp"># </span>git checkout -b &lt;BRANCH&gt; &lt;REMOTE&gt;/&lt;BRANCH NAME&gt;
</code></pre></div>

</li>
<li>
<p>Verify that you are using the intended data associated with the code you are testing:</p>
<ol>
<li>
<p>If the data format has changed in an incompatible way, modify <code>/etc/opt/topology/config-itb.py</code>:</p>
<ol>
<li>
<p>Backup the ITB configuration file:</p>
<div class="codehilite"><pre><span></span><code><span class="gp"># </span><span class="nb">cd</span> /etc/opt/topology
<span class="gp"># </span>cp -p config-itb.py<span class="o">{</span>,.bak<span class="o">}</span>
</code></pre></div>

</li>
<li>
<p>Change the <code>TOPOLOGY_DATA_DIR</code> and/or <code>CONTACT_DATA_DIR</code> lines to point to a new directories so the previous
   data does not get overwritten with incompatible data.</p>
</li>
</ol>
</li>
<li>
<p>If you need to use a different branch for the data, switch to it:</p>
<ol>
<li>
<p>Check the branch of <code>TOPOLOGY_DATA_DIR</code> from  <code>/etc/opt/topology/config-itb.py</code></p>
<div class="codehilite"><pre><span></span><code><span class="gp"># </span><span class="nb">cd</span> &lt;TOPOLOGY_DATA_DIR&gt;
<span class="gp"># </span>git fetch --all
<span class="gp"># </span>git status
</code></pre></div>

</li>
<li>
<p>Note the previous branch, you will need this later</p>
</li>
<li>If the target remote is not configured, <a href="https://help.github.com/articles/adding-a-remote/">add it</a></li>
<li>Check out the target branch:<div class="codehilite"><pre><span></span><code><span class="gp"># </span>git checkout -b &lt;BRANCH NAME&gt; &lt;REMOTE&gt;/&lt;BRANCH NAME&gt;
</code></pre></div>

</li>
</ol>
</li>
<li>
<p>Pull any upstream changes to ensure that your branch is up to date:</p>
<div class="codehilite"><pre><span></span><code><span class="gp"># </span>git pull
</code></pre></div>

</li>
</ol>
</li>
<li>
<p>For updates to the webhook app, follow the above instructions for the ITB webhook instance under
<code>/opt/topology-itb-webhook</code> and its corresponding config file, <code>/etc/opt/topology/config-itb-webhook.py</code>.</p>
</li>
<li>
<p>Restart <code>httpd</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="gp"># </span>systemctl restart httpd
</code></pre></div>

</li>
<li>
<p>Test the web interface at <a href="https://topology-itb.opensciencegrid.org">https://topology-itb.opensciencegrid.org</a>.</p>
<p>Errors and output are in <code>/var/log/httpd/error_log</code>.</p>
</li>
</ol>
<h3 id="reverting-changes">Reverting changes</h3>
<ol>
<li>
<p>Switch <code>/opt/topology-itb</code> to the previous branch:</p>
<div class="codehilite"><pre><span></span><code><span class="gp"># </span><span class="nb">cd</span> /opt/topology-itb
<span class="gp"># </span>git checkout &lt;BRANCH&gt;
</code></pre></div>

</li>
<li>
<p>For updates to the webhook app, switch <code>/opt/topology-itb-webhook</code> to the previous master:</p>
<div class="codehilite"><pre><span></span><code><span class="gp"># </span><span class="nb">cd</span> /opt/topology-itb-webhook
<span class="gp"># </span>git checkout &lt;BRANCH&gt;
</code></pre></div>

</li>
<li>
<p>If you made config changes to <code>/etc/opt/topology/config-itb.py</code> or <code>config-itb-webhook.py</code>, restore the backup.</p>
</li>
<li>
<p>If you checked out a different branch for data, revert it back to the old branch.</p>
</li>
<li>
<p>Restart <code>httpd</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="gp"># </span>systemctl restart httpd
</code></pre></div>

</li>
<li>
<p>Test the web interface at <a href="https://topology-itb.opensciencegrid.org">https://topology-itb.opensciencegrid.org</a>.</p>
</li>
</ol>
<h2 id="updating-the-production-instance">Updating the production instance</h2>
<p>Updating the production instance is similar to updating ITB instance.</p>
<ol>
<li>
<p>Update master on the Git clone at <code>/opt/topology</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="gp"># </span><span class="nb">cd</span> /opt/topology
<span class="gp"># </span>git pull origin master
</code></pre></div>

</li>
<li>
<p>For updates to the webhook app, update master on the Git clone at <code>/opt/topology-webhook</code>:</p>
<div class="codehilite"><pre><span></span><code># cd /opt/topology-webhook
# git pull origin master
</code></pre></div>

</li>
<li>
<p>Make config changes to <code>/etc/opt/topology/config-production.py</code> and/or <code>config-production-webhook.py</code> if necessary.</p>
</li>
<li>
<p>Restart <code>httpd</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="gp"># </span>systemctl restart httpd
</code></pre></div>

</li>
<li>
<p>Test the web interface at <a href="https://topology.opensciencegrid.org">https://topology.opensciencegrid.org</a>.</p>
<p>Errors and output are in <code>/var/log/httpd/error_log</code>.</p>
</li>
</ol>
<h3 id="reverting-changes_1">Reverting changes</h3>
<ol>
<li>
<p>Switch <code>/opt/topology</code> to the previous master:</p>
<div class="codehilite"><pre><span></span><code><span class="gp"># </span><span class="nb">cd</span> /opt/topology
<span class="gp">#</span><span class="c1">## (use `git reflog` to find the previous commit that was used)</span>
<span class="gp"># </span>git reset --hard &lt;COMMIT&gt;
</code></pre></div>

</li>
<li>
<p>For updates to the webhook app, switch <code>/opt/topology-webhook</code> to the previous master:</p>
<div class="codehilite"><pre><span></span><code># cd /opt/topology-webhook
### (use `git reflog` to find the previous commit that was used)
# git reset --hard &lt;COMMIT&gt;
</code></pre></div>

</li>
<li>
<p>If you made config changes to <code>/etc/opt/topology/config-production.py</code> or <code>config-production-webhook.py</code>, revert them.</p>
</li>
<li>
<p>Restart <code>httpd</code>:</p>
<div class="codehilite"><pre><span></span><code><span class="gp"># </span>systemctl restart httpd
</code></pre></div>

</li>
<li>
<p>Test the web interface at <a href="https://topology.opensciencegrid.org">https://topology.opensciencegrid.org</a>.</p>
</li>
</ol>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        <a href="../install-gwms-factory/" class="md-footer__link md-footer__link--prev" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Installing GlideinWMS Factory
            </div>
          </div>
        </a>
      
      
        <a href="../topology-contacts-data/" class="md-footer__link md-footer__link--next" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Topology and Contacts Data
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../../assets/javascripts/workers/search.fe42c31b.min.js", "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.d892486b.min.js"></script>
      
    
  </body>
</html>